<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peek-a-Boo AI Coach</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #222; color: #fff; display: flex; flex-direction: column; justify-content: center; height: 100vh; margin: 0; }
        #combo-display { font-size: 3rem; font-weight: bold; margin: 20px; color: #00e5ff; text-transform: uppercase; height: 150px; display: flex; align-items: center; justify-content: center; padding: 0 10px; line-height: 1.2;}
        #timer-display { font-size: 5rem; font-weight: bold; color: #ffeb3b; margin-bottom: 20px; font-variant-numeric: tabular-nums; }
        
        button { padding: 15px 40px; font-size: 1.5rem; background: #00e676; color: #000; border: none; border-radius: 50px; cursor: pointer; margin-top: 10px; font-weight: bold; -webkit-tap-highlight-color: transparent; }
        button:active { transform: scale(0.95); }
        button.stop { background: #ff3d00; color: white; }
        
        .controls { margin-top: 30px; background: #333; padding: 20px; border-radius: 15px; display: inline-block; max-width: 90%; }
        label { display: block; margin: 10px 0; font-size: 1.1rem; }
        input[type=range] { width: 100%; max-width: 250px; accent-color: #00e5ff; height: 30px; }
    </style>
</head>
<body>

    <div id="timer-display">3:00</div>
    <div id="combo-display">READY?</div>
    
    <button id="startBtn" onclick="toggleTraining()">START ROUND</button>
    
    <div class="controls">
        <label>‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏¢‡∏Å (‡∏ô‡∏≤‡∏ó‡∏µ): <span id="timeVal">3</span>
            <br><input type="range" id="roundTimeInput" min="1" max="5" value="3" oninput="updateTimeSetting()">
        </label>
        <hr style="border-color: #444;">
        <label>‚è≥ ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≠‡∏¢ (‡∏ß‡∏¥): <span id="speedVal">3.0</span>
            <br><input type="range" id="intervalRange" min="1500" max="6000" step="500" value="3000" oninput="document.getElementById('speedVal').innerText = (this.value/1000).toFixed(1)">
        </label>
    </div>

    <script>
        // --- ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ó‡πà‡∏≤ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢) ---
        const transitions = {
            'START': ['1', '1', '1', '1 2', '1 1', 'slip left'], 
            '1': ['2', '2', '3', 'slip left', 'body 3'],         
            '1 1': ['2', '2', 'drop'],                           
            '1 2': ['3', '5', 'roll under', 'slip right'],       
            '2': ['3', '5', 'roll under', 'pivot'],
            '3': ['2', '4', '6', 'roll under'],                  
            'body 3': ['2', '4', 'uppercut left'],               
            'slip left': ['3', 'body 3', 'uppercut left'],       
            'slip right': ['2', 'body 2', 'uppercut right'],     
            'roll under': ['2', '3', 'pivot'],
            'pivot': ['2', '1'],
            'drop': ['uppercut right', '3'],
            '5': ['2', '4', 'roll under'],
            '4': ['3', '5', 'slip left'],
            '6': ['3', '5', 'slip left']
        };

        function generateCombo(length = 4) {
            let combo = [];
            let currentMove = 'START';
            let actualLength = Math.floor(Math.random() * (length - 2 + 1)) + 2;

            for (let i = 0; i < actualLength; i++) {
                let possibleMoves = transitions[currentMove] || transitions['START'];
                let nextMove = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
                if (nextMove !== 'START') combo.push(nextMove);
                if (nextMove.includes(' ')) {
                    let parts = nextMove.split(' ');
                    currentMove = parts[parts.length - 1];
                } else {
                    currentMove = nextMove;
                }
            }
            return combo.join(" ");
        }

        let isTraining = false;
        let roundTimer = null;
        let timeLeft = 180;
        let wakeLock = null; 

        function updateTimeSetting() {
            if (!isTraining) {
                const mins = document.getElementById('roundTimeInput').value;
                document.getElementById('timeVal').innerText = mins;
                timeLeft = mins * 60;
                updateTimerDisplay();
            }
        }

        function updateTimerDisplay() {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            document.getElementById('timer-display').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        function playBell() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'triangle'; 
            osc.frequency.setValueAtTime(880, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 1.5);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 1.5);
        }

        async function requestWakeLock() {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }

        async function runComboLoop() {
            if (!isTraining) return;

            const comboText = generateCombo(5); 
            document.getElementById('combo-display').innerText = comboText;

            const msg = new SpeechSynthesisUtterance(comboText);
            msg.lang = 'en-US'; 
            
            // --- üîä ‡πÇ‡∏ã‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Sound Tuning) ---
            msg.rate = 1.1;     // ‡∏û‡∏π‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢
            msg.pitch = 0.6;    // [‡∏ó‡∏µ‡πÄ‡∏î‡πá‡∏î] ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≥‡πÅ‡∏•‡∏∞‡∏î‡∏∏ (‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡∏∑‡∏≠ 1.0)
            msg.volume = 1.0;
            // ------------------------------------

            msg.onend = function() {
                if (isTraining) {
                    const gap = document.getElementById('intervalRange').value;
                    setTimeout(runComboLoop, gap); 
                }
            };
            
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(msg);
        }

        function stopTraining() {
            isTraining = false;
            clearInterval(roundTimer);
            window.speechSynthesis.cancel();
            
            const btn = document.getElementById('startBtn');
            btn.innerText = "START ROUND";
            btn.className = "";
            
            playBell(); 
            document.getElementById('combo-display').innerText = "REST";
            updateTimeSetting();
            if (wakeLock !== null) { wakeLock.release().then(() => { wakeLock = null; }); }
        }

        function toggleTraining() {
            const btn = document.getElementById('startBtn');
            if (!isTraining) {
                isTraining = true;
                btn.innerText = "STOP";
                btn.className = "stop";
                requestWakeLock(); 
                playBell();

                roundTimer = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft <= 0) { stopTraining(); }
                }, 1000);

                setTimeout(runComboLoop, 1000);
            } else {
                stopTraining();
            }
        }
        updateTimeSetting();
    </script>
</body>
</html>